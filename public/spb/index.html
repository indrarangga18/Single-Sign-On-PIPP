<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SPB — Surat Persetujuan Berlayar • SSO PIPP</title>
    <link rel="icon" href="/images/logo-KKP.png" />
    <style>
      :root { --primary:#04255c; --white:#ffffff; --text:#0f172a; --muted:#64748b; --border:#e2e8f0; --accent:#35e1ff; }
      *{box-sizing:border-box}
      html,body{height:100%}
      body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);
           background: linear-gradient(135deg, #0b1020 0%, #0e1e3c 38%, #061a3a 100%);
          }
      .wrap{max-width:1200px;margin:0 auto;padding:28px}
      header{display:flex;align-items:center;gap:14px;margin-bottom:18px}
      .logo{width:48px;height:48px;border-radius:50%;background:#fff;display:grid;place-items:center;box-shadow:inset 0 0 0 2px #eef2f7}
      .logo img{width:42px;height:42px;object-fit:contain}
      .title{font-size:22px;font-weight:800;color:#e2f4ff;margin:0;text-shadow:0 1px 8px rgba(53,225,255,.35)}
      .subtitle{margin:2px 0 0;color:#cbd5e1;font-size:13px}

      .toolbar{display:flex;align-items:center;gap:10px;margin:16px 0}
      .btn{background:#0f172a;color:#e5e7eb;border:1px solid rgba(226,232,240,.14);border-radius:10px;padding:10px 12px;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
      .btn:hover{background:#111827}

      .layout{display:grid;grid-template-columns:1.2fr .8fr;gap:18px}
      @media (max-width:920px){.layout{grid-template-columns:1fr}}
      .panel{position:relative;border:1px solid var(--border);border-radius:16px;background:rgba(255,255,255,.94);
             backdrop-filter:saturate(1.1) blur(8px);padding:16px;box-shadow:0 10px 24px rgba(4,37,92,.18)}
      .panel h2{margin:0 0 8px;font-size:18px;font-weight:800;color:#0b3b9b}
      .panel p{margin:0 0 12px;color:var(--muted);font-size:13px}
      .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
      .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
      .field{display:flex;flex-direction:column;gap:6px}
      .field label{font-size:12px;color:#334155}
      .field input,.field select,.field textarea{padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:13px}
      .actions{display:flex;gap:8px;margin-top:8px}
      .primary{background:#0b3b9b;color:#fff;border:none;border-radius:10px;padding:10px 12px;cursor:pointer}
      .primary:hover{filter:brightness(1.05)}
      .secondary{background:#eef2f7;color:#0f172a;border:1px solid var(--border);border-radius:10px;padding:10px 12px;cursor:pointer}
      .secondary:hover{filter:brightness(1.02)}

      table{width:100%;border-collapse:collapse}
      th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;font-size:13px}
      thead th{background:#f8fafc;color:#0f172a;font-weight:700}
      tbody tr:hover{background:#f1f5f9}

      .status-chip{display:inline-block;padding:6px 10px;border-radius:999px;font-size:12px}
      .status-menunggu{background:#fff7ed;border:1px solid #fed7aa;color:#9a3412}
      .status-valid{background:#ecfeff;border:1px solid #a5f3fc;color:#0e7490}
      .status-tolak{background:#fee2e2;border:1px solid #fecaca;color:#b91c1c}
    </style>
    <style>
      /* Tambahkan orbs persis seperti halaman root */
      .fx { position: fixed; inset: 0; pointer-events: none; z-index: 0; }
      .orb { position: absolute; width: 380px; height: 380px; border-radius: 50%; filter: blur(86px); opacity: .35; }
      .orb.o1 { background: radial-gradient(closest-side, rgba(53,225,255,.9), transparent 72%); top: 10%; left: 8%; animation: float 14s ease-in-out infinite; }
      .orb.o2 { background: radial-gradient(closest-side, rgba(167,139,250,.9), transparent 72%); bottom: 12%; right: 10%; animation: float 18s ease-in-out infinite reverse; }
      .orb.o3 { background: radial-gradient(closest-side, rgba(96,165,250,.9), transparent 72%); top: 58%; left: 58%; animation: float 22s ease-in-out infinite; }
      @keyframes float { 0%,100% { transform: translate(0,0) } 50% { transform: translate(16px,-12px) } }
    </style>
  </head>
  <body>
    <div class="fx" aria-hidden="true"><span class="orb o1"></span><span class="orb o2"></span><span class="orb o3"></span></div>
    <div class="wrap">
      <header>
        <a class="logo" href="/dashboard/"><img src="/images/logo-KKP.png" alt="Logo KKP"/></a>
        <div>
          <h1 class="title">SPB — Surat Persetujuan Berlayar</h1>
          <p class="subtitle">Digitalisasi izin berlayar kapal perikanan dengan verifikasi sahbandar</p>
        </div>
      </header>

      <div class="toolbar">
        <a class="btn" href="/dashboard/">⬅️ Kembali ke Dashboard</a>
      </div>

      <div class="layout">
        <!-- Pengajuan SPB Online -->
        <section class="panel" aria-label="Pengajuan SPB Online">
          <h2>Pengajuan SPB Online</h2>
          <p>Ajukan SPB secara daring. Data akan diverifikasi oleh sahbandar.</p>
          <form id="spbForm" class="grid">
            <div class="field">
              <label for="kapal">Nama Kapal</label>
              <input id="kapal" required placeholder="cth: KM Nusantara" />
            </div>
            <div class="field">
              <label for="registrasi">No. Registrasi</label>
              <input id="registrasi" required placeholder="cth: ID-PPN-00123" />
            </div>
            <div class="field">
              <label for="gt">GT</label>
              <input id="gt" type="number" min="1" required placeholder="cth: 30" />
            </div>
            <div class="field">
              <label for="alat">Alat Tangkap</label>
              <select id="alat" required>
                <option value="">Pilih alat tangkap</option>
                <option>Pukat Cincin</option>
                <option>Rawai</option>
                <option>Pancing</option>
              </select>
            </div>
            <div class="field">
              <label for="pelabuhan">Pelabuhan Keberangkatan</label>
              <select id="pelabuhan" required>
                <option value="">Pilih pelabuhan</option>
                <option>PPN Nusantara</option>
                <option>PPP Samudera</option>
              </select>
            </div>
            <div class="field">
              <label for="tujuan">Pelabuhan Tujuan</label>
              <input id="tujuan" required placeholder="cth: PPP Samudera" />
            </div>
            <div class="field">
              <label for="tanggal">Rencana Berlayar</label>
              <input id="tanggal" type="date" required />
            </div>
            <div class="field">
              <label for="catatan">Catatan</label>
              <textarea id="catatan" rows="2" placeholder="Opsional"></textarea>
            </div>
          </form>
          <div class="actions">
            <button id="ajukan" class="primary">Ajukan SPB</button>
            <button id="reset" class="secondary" type="button">Reset</button>
          </div>
        </section>

        <!-- Validasi & Riwayat SPB -->
        <aside class="panel" aria-label="Validasi & Riwayat SPB">
          <h2>Validasi & Riwayat SPB</h2>
          <p>Verifikasi sahbandar, status pengajuan, dan rekam jejak.</p>
          <div class="grid">
            <div class="field">
              <label for="filterStatus">Filter Status</label>
              <select id="filterStatus">
                <option value="">Semua</option>
                <option value="MENUNGGU">Menunggu</option>
                <option value="TERVALIDASI">Tervalidasi</option>
                <option value="DITOLAK">Ditolak</option>
              </select>
            </div>
            <div class="field">
              <label for="search">Pencarian</label>
              <input id="search" placeholder="Cari No SPB / Kapal / Pelabuhan" />
            </div>
          </div>
          <table id="riwayat">
            <thead>
              <tr>
                <th>No SPB</th>
                <th>Kapal</th>
                <th>Pelabuhan</th>
                <th>Tgl Berlayar</th>
                <th>Status</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </aside>
      </div>

      <!-- Panel verifikasi sahbandar -->
      <section class="panel" style="margin-top:18px" aria-label="Verifikasi Sahbandar">
        <h2>Verifikasi Sahbandar</h2>
        <p>Masukkan No SPB untuk validasi (simulasi). Untuk produksi, terhubung ke API sahbandar.</p>
        <div class="grid-3">
          <div class="field">
            <label for="verNo">No SPB</label>
            <input id="verNo" placeholder="cth: SPB-2025-0001" />
          </div>
          <div class="field">
            <label for="verNama">Nama Sahbandar</label>
            <input id="verNama" placeholder="cth: Bpk. Arif" />
          </div>
          <div class="actions" style="align-self:end">
            <button id="verBtn" class="primary" type="button">Validasi</button>
          </div>
        </div>
      </section>
    </div>

    <script>
      // Penyimpanan lokal untuk riwayat (placeholder). Ganti ke API bila tersedia.
      const KEY = 'spbRiwayatV1';
      const riwayat = JSON.parse(localStorage.getItem(KEY) || '[]');
      let counter = riwayat.length ? Math.max(...riwayat.map(r => parseInt(r.no.split('-').pop()))) : 0;

      const el = {
        form: document.getElementById('spbForm'),
        ajukan: document.getElementById('ajukan'),
        reset: document.getElementById('reset'),
        tbody: document.querySelector('#riwayat tbody'),
        filterStatus: document.getElementById('filterStatus'),
        search: document.getElementById('search'),
        verNo: document.getElementById('verNo'),
        verNama: document.getElementById('verNama'),
        verBtn: document.getElementById('verBtn'),
      };

      function genNo(){
        counter += 1;
        return `SPB-${new Date().getFullYear()}-${String(counter).padStart(4,'0')}`;
      }
      function save(){ localStorage.setItem(KEY, JSON.stringify(riwayat)); }
      function statusChip(s){
        const map = { MENUNGGU:['status-menunggu','Menunggu'], TERVALIDASI:['status-valid','Tervalidasi'], DITOLAK:['status-tolak','Ditolak'] };
        const [cls, txt] = map[s] || map.MENUNGGU;
        return `<span class="status-chip ${cls}">${txt}</span>`;
      }
      function render(){
        const q = (el.search.value||'').toLowerCase();
        const st = el.filterStatus.value;
        el.tbody.innerHTML = '';
        riwayat
          .filter(r => (st ? r.status === st : true))
          .filter(r => !q || `${r.no} ${r.kapal} ${r.pelabuhan}`.toLowerCase().includes(q))
          .sort((a,b) => b.createdAt - a.createdAt)
          .forEach(r => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${r.no}</td>
              <td>${r.kapal} <small style=\"color:#64748b\">(${r.reg})</small></td>
              <td>${r.pelabuhan}</td>
              <td>${r.tanggal}</td>
              <td>${statusChip(r.status)}</td>
              <td>
                ${r.status==='MENUNGGU' ? `<button data-no=\"${r.no}\" class=\"secondary\" data-action=\"approve\">Approve</button>` : ''}
                ${r.status!=='DITOLAK' ? `<button data-no=\"${r.no}\" class=\"secondary\" data-action=\"reject\">Tolak</button>` : ''}
              </td>
            `;
            el.tbody.appendChild(tr);
          });
      }

      // Ajukan SPB
      el.ajukan.addEventListener('click', () => {
        const kapal = document.getElementById('kapal').value.trim();
        const reg = document.getElementById('registrasi').value.trim();
        const gt = parseFloat(document.getElementById('gt').value);
        const alat = document.getElementById('alat').value;
        const pelabuhan = document.getElementById('pelabuhan').value;
        const tujuan = document.getElementById('tujuan').value.trim();
        const tanggal = document.getElementById('tanggal').value;
        const catatan = document.getElementById('catatan').value.trim();
        if(!kapal || !reg || !gt || !alat || !pelabuhan || !tujuan || !tanggal){
          alert('Mohon lengkapi semua data wajib.');
          return;
        }
        const no = genNo();
        riwayat.push({ no, kapal, reg, gt, alat, pelabuhan, tujuan, tanggal, catatan, status:'MENUNGGU', createdAt: Date.now(), verifiedBy:null });
        save();
        render();
        alert(`Pengajuan SPB berhasil dibuat: ${no}\nStatus: Menunggu verifikasi sahbandar.`);
      });

      // Reset form
      el.reset.addEventListener('click', () => { el.form.reset(); });

      // Approve/Reject actions di riwayat (simulasi verifikasi)
      el.tbody.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if(!btn) return;
        const no = btn.getAttribute('data-no');
        const act = btn.getAttribute('data-action');
        const r = riwayat.find(x => x.no === no);
        if(!r) return;
        if(act==='approve'){
          r.status = 'TERVALIDASI';
          r.verifiedBy = 'Sahbandar (simulasi)';
        }else if(act==='reject'){
          r.status = 'DITOLAK';
          r.verifiedBy = null;
        }
        save(); render();
      });

      // Panel verifikasi sahbandar
      el.verBtn.addEventListener('click', () => {
        const no = (el.verNo.value||'').trim();
        const nama = (el.verNama.value||'').trim();
        if(!no){ alert('Masukkan No SPB.'); return; }
        const r = riwayat.find(x => x.no === no);
        if(!r){ alert('No SPB tidak ditemukan.'); return; }
        r.status = 'TERVALIDASI';
        r.verifiedBy = nama || 'Sahbandar';
        save(); render();
        alert(`SPB ${no} tervalidasi oleh ${r.verifiedBy}.`);
      });

      // init
      render();
    </script>
  </body>
  </html>