<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SHTI — Sertifikasi Hasil Tangkapan Ikan • SSO PIPP</title>
    <link rel="icon" href="/images/logo-KKP.png" />
    <style>
      :root { --primary:#04255c; --text:#0f172a; --muted:#64748b; --border:#e2e8f0; --accent:#35e1ff; }
      *{box-sizing:border-box}
      html,body{height:100%}
      body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);
           background: linear-gradient(135deg, #0b1020 0%, #0e1e3c 38%, #061a3a 100%);
          }
      .wrap{max-width:1200px;margin:0 auto;padding:28px}
      header{display:flex;align-items:center;gap:14px;margin-bottom:18px}
      .logo{width:48px;height:48px;border-radius:50%;background:#fff;display:grid;place-items:center;box-shadow:inset 0 0 0 2px #eef2f7}
      .logo img{width:42px;height:42px;object-fit:contain}
      .title{font-size:22px;font-weight:800;color:#e2f4ff;margin:0;text-shadow:0 1px 8px rgba(53,225,255,.35)}
      .subtitle{margin:2px 0 0;color:#cbd5e1;font-size:13px}

      .toolbar{display:flex;align-items:center;gap:10px;margin:16px 0}
      .btn{background:#0f172a;color:#e5e7eb;border:1px solid rgba(226,232,240,.14);border-radius:10px;padding:10px 12px;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
      .btn:hover{background:#111827}

      .layout{display:grid;grid-template-columns:1.2fr .8fr;gap:18px}
      @media (max-width:920px){.layout{grid-template-columns:1fr}}
      .panel{position:relative;border:1px solid var(--border);border-radius:16px;background:rgba(255,255,255,.94);
             backdrop-filter:saturate(1.1) blur(8px);padding:16px;box-shadow:0 10px 24px rgba(4,37,92,.18)}
      .panel h2{margin:0 0 8px;font-size:18px;font-weight:800;color:#0b3b9b}
      .panel p{margin:0 0 12px;color:var(--muted);font-size:13px}
      .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
      .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
      .field{display:flex;flex-direction:column;gap:6px}
      .field label{font-size:12px;color:#334155}
      .field input,.field select,.field textarea{padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:13px}
      .actions{display:flex;gap:8px;margin-top:8px}
      .primary{background:#0b3b9b;color:#fff;border:none;border-radius:10px;padding:10px 12px;cursor:pointer}
      .primary:hover{filter:brightness(1.05)}
      .secondary{background:#eef2f7;color:#0f172a;border:1px solid var(--border);border-radius:10px;padding:10px 12px;cursor:pointer}
      .secondary:hover{filter:brightness(1.02)}

      table{width:100%;border-collapse:collapse}
      th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;font-size:13px}
      thead th{background:#f8fafc;color:#0f172a;font-weight:700}
      tbody tr:hover{background:#f1f5f9}

      .status-chip{display:inline-block;padding:6px 10px;border-radius:999px;font-size:12px}
      .status-terbit{background:#ecfeff;border:1px solid #a5f3fc;color:#0e7490}
      .status-valid{background:#eaffec;border:1px solid #b6f0c0;color:#166534}
      .status-batal{background:#fee2e2;border:1px solid #fecaca;color:#b91c1c}
    </style>
    <style>
      /* Tambahkan orbs persis seperti halaman root */
      .fx { position: fixed; inset: 0; pointer-events: none; z-index: 0; }
      .orb { position: absolute; width: 380px; height: 380px; border-radius: 50%; filter: blur(86px); opacity: .35; }
      .orb.o1 { background: radial-gradient(closest-side, rgba(53,225,255,.9), transparent 72%); top: 10%; left: 8%; animation: float 14s ease-in-out infinite; }
      .orb.o2 { background: radial-gradient(closest-side, rgba(167,139,250,.9), transparent 72%); bottom: 12%; right: 10%; animation: float 18s ease-in-out infinite reverse; }
      .orb.o3 { background: radial-gradient(closest-side, rgba(96,165,250,.9), transparent 72%); top: 58%; left: 58%; animation: float 22s ease-in-out infinite; }
      @keyframes float { 0%,100% { transform: translate(0,0) } 50% { transform: translate(16px,-12px) } }
    </style>
  </head>
  <body>
    <div class="fx" aria-hidden="true"><span class="orb o1"></span><span class="orb o2"></span><span class="orb o3"></span></div>
    <div class="wrap">
      <header>
        <a class="logo" href="/dashboard/"><img src="/images/logo-KKP.png" alt="Logo KKP"/></a>
        <div>
          <h1 class="title">SHTI — Sertifikasi Hasil Tangkapan Ikan</h1>
          <p class="subtitle">Layanan penerbitan sertifikat hasil tangkapan dengan tanda tangan digital</p>
        </div>
      </header>

      <div class="toolbar">
        <a class="btn" href="/dashboard/">⬅️ Kembali ke Dashboard</a>
      </div>

      <div class="layout">
        <!-- Penerbitan Sertifikat Digital -->
        <section class="panel" aria-label="Penerbitan Sertifikat Digital">
          <h2>Penerbitan Sertifikat Digital</h2>
          <p>Terbitkan sertifikat SHTI untuk hasil tangkapan ikan.</p>
          <form id="shtiForm" class="grid">
            <div class="field">
              <label for="jenis">Jenis Ikan</label>
              <select id="jenis" required>
                <option value="">Pilih jenis ikan</option>
                <option>Tuna</option>
                <option>Cakalang</option>
                <option>Tongkol</option>
                <option>Kembung</option>
              </select>
            </div>
            <div class="field">
              <label for="volume">Volume (kg)</label>
              <input id="volume" type="number" min="1" required placeholder="cth: 1200" />
            </div>
            <div class="field">
              <label for="pelabuhan">Pelabuhan Pendaratan</label>
              <select id="pelabuhan" required>
                <option value="">Pilih pelabuhan</option>
                <option>PPN Nusantara</option>
                <option>PPP Samudera</option>
              </select>
            </div>
            <div class="field">
              <label for="tanggal">Tanggal Pendaratan</label>
              <input id="tanggal" type="date" required />
            </div>
            <div class="field">
              <label for="dokumen">Nomor Dokumen</label>
              <input id="dokumen" required placeholder="cth: DOC-2025-0001" />
            </div>
            <div class="field">
              <label for="keterangan">Keterangan</label>
              <textarea id="keterangan" rows="2" placeholder="Opsional"></textarea>
            </div>
          </form>
          <div class="actions">
            <button id="terbitkan" class="primary">Terbitkan Sertifikat</button>
            <button id="reset" class="secondary" type="button">Reset</button>
          </div>
        </section>

        <!-- Validasi Dokumen & Riwayat -->
        <aside class="panel" aria-label="Validasi Dokumen & Riwayat">
          <h2>Validasi Dokumen</h2>
          <p>Periksa keabsahan sertifikat menggunakan nomor atau hash tanda tangan digital.</p>
          <div class="grid">
            <div class="field">
              <label for="valNo">No Sertifikat</label>
              <input id="valNo" placeholder="cth: SHTI-2025-0001" />
            </div>
            <div class="field">
              <label for="valHash">Hash Sertifikat</label>
              <input id="valHash" placeholder="hash tanda tangan digital" />
            </div>
          </div>
          <div class="grid">
            <div class="field">
              <label for="validator">Nama Validator</label>
              <input id="validator" placeholder="cth: Pejabat TTD" />
            </div>
            <div class="actions" style="align-self:end">
              <button id="validasi" class="primary" type="button">Validasi</button>
            </div>
          </div>

          <h2 style="margin-top:16px">Riwayat Sertifikat</h2>
          <div class="grid">
            <div class="field">
              <label for="filterStatus">Filter Status</label>
              <select id="filterStatus">
                <option value="">Semua</option>
                <option value="DITERBITKAN">Diterbitkan</option>
                <option value="TERVALIDASI">Tervalidasi</option>
                <option value="DIBATALKAN">Dibatalkan</option>
              </select>
            </div>
            <div class="field">
              <label for="search">Pencarian</label>
              <input id="search" placeholder="Cari No / Jenis / Pelabuhan" />
            </div>
          </div>
          <table id="riwayat">
            <thead>
              <tr>
                <th>No Sertifikat</th>
                <th>Jenis</th>
                <th>Volume (kg)</th>
                <th>Pelabuhan</th>
                <th>Tgl</th>
                <th>Status</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </aside>
      </div>
    </div>

    <script>
      const KEY = 'shtiCertsV1';
      const certs = JSON.parse(localStorage.getItem(KEY) || '[]');
      let counter = certs.length ? Math.max(...certs.map(r => parseInt(r.no.split('-').pop()))) : 0;

      const el = {
        form: document.getElementById('shtiForm'),
        terbitkan: document.getElementById('terbitkan'),
        reset: document.getElementById('reset'),
        tbody: document.querySelector('#riwayat tbody'),
        filterStatus: document.getElementById('filterStatus'),
        search: document.getElementById('search'),
        valNo: document.getElementById('valNo'),
        valHash: document.getElementById('valHash'),
        validator: document.getElementById('validator'),
        validasi: document.getElementById('validasi'),
      };

      function genNo(){
        counter += 1;
        return `SHTI-${new Date().getFullYear()}-${String(counter).padStart(4,'0')}`;
      }
      function makeHash(payload){
        try {
          const text = JSON.stringify(payload);
          // Simulasi hash ringan (bukan kriptografi asli)
          let h = 0; for (let i=0;i<text.length;i++){ h = (h<<5) - h + text.charCodeAt(i); h |= 0; }
          return (h>>>0).toString(16) + '-' + btoa(unescape(encodeURIComponent(text))).slice(0,12);
        } catch(e){
          return Math.random().toString(16).slice(2,10);
        }
      }
      function save(){ localStorage.setItem(KEY, JSON.stringify(certs)); }
      function chip(s){
        const map = { DITERBITKAN:['status-terbit','Diterbitkan'], TERVALIDASI:['status-valid','Tervalidasi'], DIBATALKAN:['status-batal','Dibatalkan'] };
        const [cls, txt] = map[s] || map.DITERBITKAN;
        return `<span class="status-chip ${cls}">${txt}</span>`;
      }
      function render(){
        const q = (el.search.value||'').toLowerCase();
        const st = el.filterStatus.value;
        el.tbody.innerHTML = '';
        certs
          .filter(r => (st ? r.status === st : true))
          .filter(r => !q || `${r.no} ${r.jenis} ${r.pelabuhan}`.toLowerCase().includes(q))
          .sort((a,b) => b.createdAt - a.createdAt)
          .forEach(r => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${r.no}</td>
              <td>${r.jenis}</td>
              <td>${r.volume}</td>
              <td>${r.pelabuhan}</td>
              <td>${r.tanggal}</td>
              <td>${chip(r.status)}</td>
              <td>
                ${r.status!=='DIBATALKAN' ? `<button data-no=\"${r.no}\" class=\"secondary\" data-action=\"cancel\">Batalkan</button>` : ''}
                <button data-no="${r.no}" class="secondary" data-action="export">Export</button>
              </td>
            `;
            el.tbody.appendChild(tr);
          });
      }

      // Terbitkan sertifikat
      el.terbitkan.addEventListener('click', () => {
        const jenis = document.getElementById('jenis').value;
        const volume = parseFloat(document.getElementById('volume').value);
        const pelabuhan = document.getElementById('pelabuhan').value;
        const tanggal = document.getElementById('tanggal').value;
        const dokumen = document.getElementById('dokumen').value.trim();
        const keterangan = document.getElementById('keterangan').value.trim();
        if(!jenis || !volume || !pelabuhan || !tanggal || !dokumen){
          alert('Mohon lengkapi semua data wajib.'); return;
        }
        const no = genNo();
        const payload = { no, jenis, volume, pelabuhan, tanggal, dokumen, keterangan };
        const hash = makeHash(payload);
        certs.push({ ...payload, hash, status:'DITERBITKAN', createdAt: Date.now(), validatedBy:null });
        save(); render();
        alert(`Sertifikat diterbitkan: ${no}\nHash: ${hash}`);
      });

      // Reset form
      el.reset.addEventListener('click', () => { el.form.reset(); });

      // Aksi riwayat
      el.tbody.addEventListener('click', (e) => {
        const btn = e.target.closest('button'); if(!btn) return;
        const no = btn.getAttribute('data-no');
        const act = btn.getAttribute('data-action');
        const r = certs.find(x => x.no === no); if(!r) return;
        if(act==='cancel'){
          r.status = 'DIBATALKAN'; r.validatedBy = null;
        } else if(act==='export'){
          const dataStr = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(r,null,2));
          const a = document.createElement('a'); a.setAttribute('href', dataStr); a.setAttribute('download', `${r.no}.json`); a.click();
        }
        save(); render();
      });

      // Validasi dokumen
      el.validasi.addEventListener('click', () => {
        const no = (el.valNo.value||'').trim();
        const hash = (el.valHash.value||'').trim();
        const validator = (el.validator.value||'').trim() || 'Validator';
        const r = certs.find(x => (no && x.no === no) || (hash && x.hash === hash));
        if(!r){ alert('Sertifikat tidak ditemukan.'); return; }
        r.status = 'TERVALIDASI';
        r.validatedBy = validator;
        save(); render();
        alert(`Sertifikat ${r.no} tervalidasi oleh ${validator}.`);
      });

      el.filterStatus.addEventListener('change', render);
      el.search.addEventListener('input', render);
      render();
    </script>
  </body>
  </html>